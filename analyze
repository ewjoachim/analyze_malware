#!/bin/bash -eu

package_name="$1"
shift

grep_targets="${@:-}"

json=$(curl "https://pypi.org/pypi/${package_name}/json" 2>/dev/null)
version=$(echo $json | jq '.info.version')
urls=$(echo $json | jq -r ".releases|.${version}|.[].url")

rm -rf malware
mkdir malware
pushd malware >/dev/null

for url in $urls; do
    name=$(basename $url)
    mkdir $name
    pushd $name >/dev/null
    curl $url 2>/dev/null -O
    case $name in
        *.whl)
            unzip *.whl 2>&1 1>/dev/null
            ;;

        *.tar.gz)
            tar -zxvf *.tar.gz 2>&1 1>/dev/null
            ;;

    esac

    popd >/dev/null
done

if [ "${grep_targets}" = "" ]; then
    read -p "Press enter to delete files"
else
    for target in $grep_targets;
    do
        ack -C3 "$target" . || true
    done
fi

popd >/dev/null
rm -rf malware
